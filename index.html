<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAZOL (MZLx) Token Sale</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #008080;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 420px;
      margin: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      padding: 32px;
      text-align: center;
    }
    .logo {
      width: 120px;
      margin: 0 auto 16px auto;
      display: block;
      border-radius: 50%;
    }
    h1 {
      font-size: 1.4em;
      margin-bottom: 8px;
      color: #333;
    }
    .subtitle {
      color: #1a73e8;
      font-size: 1em;
      margin-bottom: 24px;
    }
    .desc {
      color: #555;
      margin-bottom: 24px;
      line-height: 1.5;
    }
    .input-group {
      margin-bottom: 18px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-weight: bold;
    }
    input[type="number"] {
      width: 100%;
      padding: 12px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    .output {
      margin-bottom: 18px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    button {
      width: 100%;
      padding: 14px;
      background: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1.1em;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.3s;
    }
    button:hover {
      background: #0d5abf;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .wallet-options {
      display: none;
      margin-top: 10px;
    }
    .wallet-option {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .wallet-option:hover {
      background: #f0f7ff;
    }
    .wallet-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    .footer {
      text-align: center;
      color: #aaa;
      font-size: 0.9em;
      margin-top: 24px;
    }
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .connected-wallet {
      font-size: 0.9em;
      margin-top: 10px;
      color: #28a745;
      font-weight: bold;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@1.7.8/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="container">
    <img class="logo" src="https://i.imgur.com/gaCl9Zz.jpeg" alt="MAZOL Logo" />
    <h1>Private Sale: MAZOL (MZLx) Tokens</h1>
    <div class="subtitle">Blockchain Powered Trust-Grade Training and Marketplace Solutions</div>
    <div class="desc">Buy MZLx tokens with USDT (BEP-20, BNB Chain).<br>1 MZLx = 0.15 USDT</div>
    
    <div class="input-group">
      <label for="usdtAmount">Enter USDT Amount</label>
      <input type="number" id="usdtAmount" min="0.15" step="0.01" placeholder="e.g. 15" />
    </div>
    
    <div class="output" id="mzlxOutput">You will receive: 0 MZLx</div>
    
    <button id="connectBtn">Connect Wallet</button>
    <div id="walletInfo" class="connected-wallet" style="display: none;"></div>
    
    <div class="wallet-options" id="walletOptions">
      <div class="wallet-option" id="metamaskOption">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="wallet-icon" alt="MetaMask">
        <span>MetaMask</span>
      </div>
      <div class="wallet-option" id="walletConnectOption">
        <img src="https://avatars.githubusercontent.com/u/37784886" class="wallet-icon" alt="WalletConnect">
        <span>WalletConnect</span>
      </div>
    </div>
    
    <button id="buyBtn" disabled>Buy MZLx</button>
    
    <div class="status" id="statusMessage"></div>
    <div class="footer">Powered by MAZOLX</div>
  </div>

  <script>
    // ===== CONFIGURATION ===== //
    const TOKEN_PRICE = 0.15; // 1 MZLx = 0.15 USDT
    const MZLX_ADDRESS = "0x49F4a728BD98480E92dBfc6a82d595DA9d1F7b83";
    const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
    const RECEIVER_ADDRESS = "0x4bd6033bCe207fa4F5a2Bd4d003a690ed4c3D859";
    const BNB_CHAIN_ID = 56;
    const API_BASE_URL = "https://your-backend.onrender.com"; // UPDATE THIS

    // ===== UI ELEMENTS ===== //
    const usdtInput = document.getElementById("usdtAmount");
    const mzlxOutput = document.getElementById("mzlxOutput");
    const connectBtn = document.getElementById("connectBtn");
    const buyBtn = document.getElementById("buyBtn");
    const walletOptions = document.getElementById("walletOptions");
    const statusMessage = document.getElementById("statusMessage");
    const metamaskOption = document.getElementById("metamaskOption");
    const walletConnectOption = document.getElementById("walletConnectOption");
    const walletInfo = document.getElementById("walletInfo");

    // ===== STATE VARIABLES ===== //
    let provider = null;
    let signer = null;
    let userAddress = null;
    let usdtDecimals = 18;
    let mzlxDecimals = 18;
    let walletConnectProvider = null;

    // ===== INITIAL SETUP ===== //
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize event listeners
      usdtInput.addEventListener('input', updateMZLxOutput);
      connectBtn.addEventListener('click', toggleWalletOptions);
      metamaskOption.addEventListener('click', connectMetaMask);
      walletConnectOption.addEventListener('click', connectWalletConnect);
      buyBtn.addEventListener('click', buyMZLxTokens);
      
      // Auto-connect if returning user
      if (window.ethereum && window.ethereum.selectedAddress) {
        connectMetaMask();
      }
      
      // Initialize calculation
      updateMZLxOutput();
    });

    // ===== REAL-TIME CALCULATION ===== //
    function updateMZLxOutput() {
      const usdtValue = parseFloat(usdtInput.value) || 0;
      const mzlxAmount = usdtValue > 0 ? usdtValue / TOKEN_PRICE : 0;
      
      mzlxOutput.textContent = `You will receive: ${mzlxAmount.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })} MZLx`;
      
      // Update button state
      buyBtn.disabled = !userAddress || usdtValue < TOKEN_PRICE;
    }

    // ===== WALLET CONNECTION ===== //
    function toggleWalletOptions() {
      if (walletOptions.style.display === 'block') {
        walletOptions.style.display = 'none';
      } else {
        walletOptions.style.display = 'block';
      }
    }

    async function connectMetaMask() {
      if (!window.ethereum) {
        showStatus("MetaMask not detected. Please install MetaMask first.", "error");
        return;
      }
      
      try {
        // Create provider
        provider = new ethers.BrowserProvider(window.ethereum);
        
        // Setup provider
        await setupProvider(provider);
        
        // Update UI
        walletOptions.style.display = 'none';
        showStatus("MetaMask connected successfully!", "success");
      } catch (err) {
        showStatus("MetaMask connection failed: " + (err.message || err), "error");
      }
    }

    async function connectWalletConnect() {
      try {
        // Initialize WalletConnect
        walletConnectProvider = new WalletConnectProvider.default({
          rpc: {
            56: "https://bsc-dataseed.binance.org/",
          },
          chainId: 56,
        });

        // Enable session
        await walletConnectProvider.enable();
        
        // Create provider
        provider = new ethers.Web3Provider(walletConnectProvider);
        
        // Setup provider
        await setupProvider(provider);
        
        // Update UI
        walletOptions.style.display = 'none';
        showStatus("WalletConnect connected successfully!", "success");
      } catch (err) {
        showStatus("WalletConnect failed: " + (err.message || err), "error");
      }
    }

    async function setupProvider(provider) {
      try {
        // Switch to BNB Chain
        await switchToBNBChain(provider);
        
        // Get signer
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Update UI
        connectBtn.textContent = "Connected";
        connectBtn.disabled = true;
        walletInfo.textContent = `Connected: ${shortenAddress(userAddress)}`;
        walletInfo.style.display = "block";
        
        // Get token decimals
        const usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
        usdtDecimals = await usdtContract.decimals();
        
        const mzlxContract = new ethers.Contract(MZLX_ADDRESS, ERC20_ABI, provider);
        mzlxDecimals = await mzlxContract.decimals();
        
        // Update button state
        updateMZLxOutput();
      } catch (err) {
        showStatus("Connection failed: " + (err.message || err), "error");
      }
    }

    async function switchToBNBChain(provider) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: "0x38" }]);
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await provider.send("wallet_addEthereumChain", [{
              chainId: "0x38",
              chainName: "Binance Smart Chain",
              nativeCurrency: { 
                name: "BNB", 
                symbol: "bnb", 
                decimals: 18 
              },
              rpcUrls: ["https://bsc-dataseed.binance.org/"],
              blockExplorerUrls: ["https://bscscan.com"]
            }]);
          } catch (addError) {
            throw new Error("Failed to add BNB Chain to wallet");
          }
        } else {
          throw switchError;
        }
      }
    }

    // ===== PURCHASE FUNCTIONALITY ===== //
    async function buyMZLxTokens() {
      const usdtValue = parseFloat(usdtInput.value);
      
      // Validate input
      if (!usdtValue || usdtValue < TOKEN_PRICE) {
        showStatus(`Please enter at least ${TOKEN_PRICE} USDT`, "error");
        return;
      }
      
      try {
        // Calculate MZLx amount
        const mzlxAmount = usdtValue / TOKEN_PRICE;
        const usdtAmount = ethers.parseUnits(usdtValue.toString(), usdtDecimals);
        
        // Check balance
        const usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
        const usdtBalance = await usdtContract.balanceOf(userAddress);
        
        if (usdtBalance < usdtAmount) {
          showStatus("Insufficient USDT balance", "error");
          return;
        }
        
        // Check allowance
        const allowance = await usdtContract.allowance(userAddress, RECEIVER_ADDRESS);
        
        if (allowance < usdtAmount) {
          buyBtn.textContent = "Approving USDT...";
          buyBtn.disabled = true;
          
          const approveTx = await usdtContract.approve(RECEIVER_ADDRESS, usdtAmount);
          await approveTx.wait();
        }
        
        // Send payment
        buyBtn.textContent = "Processing Purchase...";
        buyBtn.disabled = true;
        
        const usdtTx = await usdtContract.transfer(RECEIVER_ADDRESS, usdtAmount);
        await usdtTx.wait();
        
        // Show success message
        showStatus(`Success! ${mzlxAmount.toFixed(2)} MZLx will be sent to your wallet shortly`, "success");
        
        // Send to backend (for token distribution)
        await sendToBackend({
          walletAddress: userAddress,
          usdtAmount: usdtValue,
          mzlxAmount: mzlxAmount,
          txHash: usdtTx.hash
        });
        
      } catch (err) {
        showStatus("Transaction failed: " + (err.message || err), "error");
      } finally {
        buyBtn.textContent = "Buy MZLx";
        updateMZLxOutput();
      }
    }

    // ===== HELPER FUNCTIONS ===== //
    async function sendToBackend(data) {
      if (!API_BASE_URL || API_BASE_URL === "https://your-backend.onrender.com") {
        console.log("Backend not configured. Skipping backend call.");
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/purchase`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error('Backend request failed');
        }
      } catch (err) {
        console.error("Backend error:", err);
      }
    }

    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status ' + type;
      statusMessage.style.display = 'block';
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 10000);
    }

    function shortenAddress(address) {
      return address ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : '';
    }

    // ERC20 ABI (minimal)
    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address owner) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
  </script>
</body>
</html>
