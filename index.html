<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAZOL (MZLx) Token Sale</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #006666, #008080);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 450px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      padding: 30px;
      text-align: center;
    }
    
    .logo {
      width: 110px;
      height: 110px;
      margin: 0 auto 20px auto;
      display: block;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #1a73e8;
    }
    
    h1 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: #222;
    }
    
    .subtitle {
      color: #1a73e8;
      font-size: 1rem;
      margin-bottom: 25px;
    }
    
    .desc {
      color: #555;
      margin-bottom: 25px;
      font-size: 0.95rem;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }
    
    input[type="number"] {
      width: 100%;
      padding: 16px;
      font-size: 1.05rem;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #f9f9f9;
    }
    
    .output {
      margin-bottom: 20px;
      padding: 15px;
      background: #f0f9ff;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.1rem;
      color: #1a73e8;
      border: 1px solid #cce5ff;
    }
    
    button {
      width: 100%;
      padding: 17px;
      background: linear-gradient(to right, #1a73e8, #0d5abf);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    button:hover:not(:disabled) {
      background: linear-gradient(to right, #0d5abf, #0a4a9e);
    }
    
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    
    .wallet-options {
      display: none;
      margin-top: 15px;
    }
    
    .wallet-option {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      background: #f8f9fa;
      transition: all 0.3s;
    }
    
    .wallet-option:hover {
      background: #eef5ff;
      border-color: #1a73e8;
    }
    
    .wallet-icon {
      width: 30px;
      height: 30px;
      margin-right: 12px;
      object-fit: contain;
    }
    
    .footer {
      text-align: center;
      color: #999;
      font-size: 0.85rem;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      display: none;
      font-size: 0.95rem;
    }
    
    .status.processing {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(26, 115, 232, 0.3);
      border-radius: 50%;
      border-top-color: #1a73e8;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .connected-info {
      margin: 15px 0;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 8px;
      color: #28a745;
      font-weight: 600;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@1.7.8/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="container">
    <img class="logo" src="https://i.imgur.com/gaCl9Zz.jpeg" alt="MAZOL Logo" />
    <h1>Private Sale: MAZOL (MZLx) Tokens</h1>
    <div class="subtitle">Blockchain Powered Trust-Grade Training and Marketplace Solutions</div>
    <div class="desc">Buy MZLx tokens with USDT (BEP-20, BNB Chain)<br>1 MZLx = 0.15 USDT</div>
    
    <div class="input-group">
      <label for="usdtAmount">Enter USDT Amount</label>
      <input type="number" id="usdtAmount" min="0.15" step="0.01" placeholder="e.g. 15" />
    </div>
    
    <div class="output" id="mzlxOutput">You will receive: 0 MZLx</div>
    
    <button id="connectBtn">Connect Wallet</button>
    
    <div class="wallet-options" id="walletOptions">
      <div class="wallet-option" id="metamaskOption">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="wallet-icon" alt="MetaMask">
        <span>MetaMask</span>
      </div>
      <div class="wallet-option" id="walletConnectOption">
        <img src="https://avatars.githubusercontent.com/u/37784886" class="wallet-icon" alt="WalletConnect">
        <span>WalletConnect</span>
      </div>
    </div>
    
    <div class="connected-info" id="connectedInfo" style="display: none;">
      Wallet Connected: <span id="walletAddress"></span>
    </div>
    
    <button id="buyBtn" disabled>Buy MZLx</button>
    
    <div class="status" id="statusMessage"></div>
    <div class="footer">Powered by MAZOLX</div>
  </div>

  <script>
    // ===== CONFIGURATION ===== //
    const TOKEN_PRICE = 0.15;
    const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
    const RECEIVER_ADDRESS = "0x4bd6033bCe207fa4F5a2Bd4d003a690ed4c3D859";
    const API_BASE_URL = "https://mazol.onrender.com";
    const BNB_CHAIN_ID = 56;

    // ===== UI ELEMENTS ===== //
    const usdtInput = document.getElementById("usdtAmount");
    const mzlxOutput = document.getElementById("mzlxOutput");
    const connectBtn = document.getElementById("connectBtn");
    const buyBtn = document.getElementById("buyBtn");
    const walletOptions = document.getElementById("walletOptions");
    const statusMessage = document.getElementById("statusMessage");
    const metamaskOption = document.getElementById("metamaskOption");
    const walletConnectOption = document.getElementById("walletConnectOption");
    const connectedInfo = document.getElementById("connectedInfo");
    const walletAddress = document.getElementById("walletAddress");

    // ===== STATE VARIABLES ===== //
    let provider = null;
    let signer = null;
    let userAddress = null;
    let usdtDecimals = 18;
    let currentUSDTAmount = 0;
    let currentMZLxAmount = 0;
    let walletConnectProvider = null;

    // ===== INITIAL SETUP ===== //
    document.addEventListener('DOMContentLoaded', initApp);
    
    function initApp() {
      usdtInput.addEventListener('input', handleUSDTInput);
      connectBtn.addEventListener('click', toggleWalletOptions);
      metamaskOption.addEventListener('click', () => connectWallet('metamask'));
      walletConnectOption.addEventListener('click', () => connectWallet('walletconnect'));
      buyBtn.addEventListener('click', startPurchaseProcess);
      updateMZLxOutput();
    }

    function toggleWalletOptions() {
      walletOptions.style.display = walletOptions.style.display === 'flex' ? 'none' : 'flex';
    }

    // ===== REAL-TIME CALCULATION ===== //
    function handleUSDTInput() {
      currentUSDTAmount = parseFloat(usdtInput.value) || 0;
      currentMZLxAmount = currentUSDTAmount / TOKEN_PRICE;
      updateMZLxOutput();
      updateBuyButtonState();
    }

    function updateMZLxOutput() {
      mzlxOutput.textContent = `You will receive: ${currentMZLxAmount.toFixed(2)} MZLx`;
    }
    
    function updateBuyButtonState() {
      buyBtn.disabled = !userAddress || currentUSDTAmount < TOKEN_PRICE;
    }

    // ===== WALLET CONNECTION ===== //
    async function connectWallet(walletType) {
      walletOptions.style.display = 'none';
      
      try {
        showStatus("Connecting wallet...", "processing");
        
        if (walletType === 'metamask') {
          await connectMetaMask();
        } else if (walletType === 'walletconnect') {
          await connectWalletConnect();
        }
        
        showStatus("Wallet connected successfully!", "success");
        connectBtn.textContent = "Wallet Connected";
        connectBtn.disabled = true;
        connectedInfo.style.display = "block";
        walletAddress.textContent = shortenAddress(userAddress);
        updateBuyButtonState();
        
      } catch (err) {
        showStatus("Connection failed: " + (err.message || err), "error");
      }
    }

    async function connectMetaMask() {
      if (!window.ethereum) {
        throw new Error("MetaMask not installed");
      }
      
      provider = new ethers.BrowserProvider(window.ethereum);
      await switchToBNBChain(provider);
      signer = await provider.getSigner();
      userAddress = await signer.getAddress();
    }

    async function connectWalletConnect() {
      walletConnectProvider = new WalletConnectProvider.default({
        rpc: { 
          56: "https://bsc-dataseed.binance.org/" 
        },
        chainId: BNB_CHAIN_ID
      });
      
      await walletConnectProvider.enable();
      provider = new ethers.Web3Provider(walletConnectProvider);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
    }

    async function switchToBNBChain(provider) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: "0x38" }]);
      } catch (switchError) {
        if (switchError.code === 4902) {
          await provider.send("wallet_addEthereumChain", [{
            chainId: "0x38",
            chainName: "Binance Smart Chain",
            nativeCurrency: { name: "BNB", symbol: "bnb", decimals: 18 },
            rpcUrls: ["https://bsc-dataseed.binance.org/"],
            blockExplorerUrls: ["https://bscscan.com"]
          }]);
        } else {
          throw switchError;
        }
      }
    }

    // ===== PURCHASE WORKFLOW ===== //
    async function startPurchaseProcess() {
      if (!userAddress || currentUSDTAmount < TOKEN_PRICE) {
        showStatus("Please connect wallet and enter valid USDT amount", "error");
        return;
      }
      
      try {
        showStatus("Preparing transaction...", "processing");
        
        // Get USDT contract
        const usdtContract = new ethers.Contract(
          USDT_ADDRESS,
          [
            "function decimals() view returns (uint8)",
            "function balanceOf(address owner) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function transfer(address to, uint256 amount) public returns (bool)"
          ],
          signer
        );
        
        // Get decimals
        const decimals = await usdtContract.decimals();
        const usdtValue = ethers.parseUnits(currentUSDTAmount.toString(), decimals);
        
        // Check balance
        const balance = await usdtContract.balanceOf(userAddress);
        if (balance < usdtValue) {
          showStatus(`Insufficient USDT balance. You need ${currentUSDTAmount} USDT`, "error");
          return;
        }
        
        // Check allowance
        const allowance = await usdtContract.allowance(userAddress, RECEIVER_ADDRESS);
        if (allowance < usdtValue) {
          showStatus("Approval needed. Please confirm in your wallet...", "processing");
          
          // Trigger wallet's native approval interface
          const approveTx = await usdtContract.approve(RECEIVER_ADDRESS, usdtValue);
          await approveTx.wait();
        }
        
        showStatus("Sending USDT. Please confirm in your wallet...", "processing");
        
        // Trigger wallet's native transfer interface
        const transferTx = await usdtContract.transfer(RECEIVER_ADDRESS, usdtValue);
        const receipt = await transferTx.wait();
        
        if (receipt.status === 1) {
          // Notify backend
          await notifyBackend(userAddress, currentUSDTAmount, currentMZLxAmount, transferTx.hash);
          
          showStatus(`Success! ${currentMZLxAmount.toFixed(2)} MZLx will be sent to your wallet`, "success");
          usdtInput.value = "";
          currentUSDTAmount = 0;
          currentMZLxAmount = 0;
          updateMZLxOutput();
          updateBuyButtonState();
        } else {
          showStatus("Transaction failed. Please try again.", "error");
        }
        
      } catch (err) {
        showStatus("Transaction failed: " + (err.message || err), "error");
      }
    }
    
    // Notify backend about purchase
    async function notifyBackend(walletAddress, usdtAmount, mzlxAmount, txHash) {
      if (!API_BASE_URL) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/purchase`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            walletAddress,
            usdtAmount,
            mzlxAmount,
            txHash
          })
        });
        
        if (!response.ok) {
          throw new Error('Backend notification failed');
        }
        
        return await response.json();
      } catch (err) {
        console.error("Backend notification error:", err);
      }
    }

    // ===== HELPER FUNCTIONS ===== //
    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status ' + type;
      statusMessage.style.display = 'block';
      
      if (type === 'processing') {
        statusMessage.innerHTML = `<span class="spinner"></span> ${message}`;
      }
      
      if (type === 'success') {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 10000);
      }
    }
    
    function shortenAddress(address) {
      return address ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : '';
    }
  </script>
</body>
</html>
