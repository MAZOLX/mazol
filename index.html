<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAZOL (MZLx) Token Sale</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #006666, #008080); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .container { width: 100%; max-width: 450px; background: #ffffff; border-radius: 16px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); padding: 30px; text-align: center; }
    .logo { width: 110px; height: 110px; margin: 0 auto 20px auto; display: block; border-radius: 50%; object-fit: cover; border: 3px solid #1a73e8; }
    h1 { font-size: 1.4rem; margin-bottom: 10px; color: #222; }
    .subtitle { color: #1a73e8; font-size: 1rem; margin-bottom: 25px; }
    .desc { color: #555; margin-bottom: 25px; font-size: 0.95rem; }
    .input-group { margin-bottom: 20px; text-align: left; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
    input[type="number"] { width: 100%; padding: 16px; font-size: 1.05rem; border-radius: 10px; border: 1px solid #ddd; background: #f9f9f9; }
    .output { margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 10px; font-weight: bold; font-size: 1.1rem; color: #1a73e8; border: 1px solid #cce5ff; }
    button { width: 100%; padding: 17px; background: linear-gradient(to right, #1a73e8, #0d5abf); color: #fff; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 15px; transition: all 0.3s; }
    button:hover:not(:disabled) { background: linear-gradient(to right, #0d5abf, #0a4a9e); }
    button:disabled { background: #aaa; cursor: not-allowed; }
    .wallet-options { display: none; margin-top: 15px; }
    .wallet-option { display: flex; align-items: center; justify-content: center; padding: 15px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #f8f9fa; transition: all 0.3s; }
    .wallet-option:hover { background: #eef5ff; border-color: #1a73e8; }
    .wallet-icon { width: 30px; height: 30px; margin-right: 12px; object-fit: contain; }
    .footer { text-align: center; color: #999; font-size: 0.85rem; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
    .status { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; font-size: 0.95rem; }
    .status.processing { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(26, 115, 232, 0.3); border-radius: 50%; border-top-color: #1a73e8; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .connected-info { margin: 15px 0; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #28a745; font-weight: 600; }
    .mobile-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 8px; padding: 10px; margin-bottom: 15px; display: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@1.7.8/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="container">
    <img class="logo" src="https://i.imgur.com/gaCl9Zz.jpeg" alt="MAZOL Logo" />
    <h1>Private Sale: MAZOL (MZLx) Tokens</h1>
    <div class="subtitle">Blockchain Powered Trust-Grade Training and Marketplace Solutions</div>
    <div class="desc">Buy MZLx tokens with USDT (BEP-20, BNB Chain)<br>1 MZLx = 0.15 USDT</div>
    
    <div class="mobile-warning" id="mobileWarning">
      <strong>Mobile Users:</strong> After connecting, return to this page to complete your purchase
    </div>
    
    <div class="input-group">
      <label for="usdtAmount">Enter USDT Amount</label>
      <input type="number" id="usdtAmount" min="0.15" step="0.01" placeholder="e.g. 15" />
    </div>
    
    <div class="output" id="mzlxOutput">You will receive: 0 MZLx</div>
    
    <button id="connectBtn">Connect Wallet</button>
    
    <div class="wallet-options" id="walletOptions">
      <div class="wallet-option" id="metamaskOption">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="wallet-icon" alt="MetaMask">
        <span>MetaMask</span>
      </div>
      <div class="wallet-option" id="walletConnectOption">
        <img src="https://avatars.githubusercontent.com/u/37784886" class="wallet-icon" alt="WalletConnect">
        <span>WalletConnect</span>
      </div>
    </div>
    
    <div class="connected-info" id="connectedInfo" style="display: none;">
      Wallet Connected: <span id="walletAddress"></span>
    </div>
    
    <button id="buyBtn" disabled>Buy MZLx</button>
    
    <div class="status" id="statusMessage"></div>
    <div class="footer">Powered by MAZOLX</div>
  </div>

  <script>
    // ===== GUARANTEED METAMASK WORKFLOW SOLUTION ===== //
    const TOKEN_PRICE = 0.15;
    const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
    const RECEIVER_ADDRESS = "0x4bd6033bCe207fa4F5a2Bd4d003a690ed4c3D859";
    const API_BASE_URL = "https://mazol.onrender.com";
    const BNB_CHAIN_ID = 56;
    const USDT_ABI = [
      "function decimals() view returns (uint8)",
      "function balanceOf(address owner) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function transfer(address to, uint256 amount) public returns (bool)"
    ];

    // UI Elements
    const usdtInput = document.getElementById("usdtAmount");
    const mzlxOutput = document.getElementById("mzlxOutput");
    const connectBtn = document.getElementById("connectBtn");
    const buyBtn = document.getElementById("buyBtn");
    const walletOptions = document.getElementById("walletOptions");
    const statusMessage = document.getElementById("statusMessage");
    const metamaskOption = document.getElementById("metamaskOption");
    const walletConnectOption = document.getElementById("walletConnectOption");
    const connectedInfo = document.getElementById("connectedInfo");
    const walletAddress = document.getElementById("walletAddress");
    const mobileWarning = document.getElementById("mobileWarning");

    // State
    let provider = null;
    let signer = null;
    let userAddress = null;
    let currentUSDTAmount = 0;
    let currentMZLxAmount = 0;
    let walletConnectProvider = null;
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // Initialize
    document.addEventListener('DOMContentLoaded', initApp);
    
    function initApp() {
      // Show mobile warning if needed
      if (isMobile) {
        mobileWarning.style.display = 'block';
      }
      
      usdtInput.addEventListener('input', handleUSDTInput);
      connectBtn.addEventListener('click', toggleWalletOptions);
      metamaskOption.addEventListener('click', connectMetaMask);
      walletConnectOption.addEventListener('click', connectWalletConnect);
      buyBtn.addEventListener('click', startPurchaseProcess);
      updateMZLxOutput();
      
      // Check if we're returning from a mobile redirect
      checkReturnFromMobile();
    }

    // Check if returning from mobile redirect
    function checkReturnFromMobile() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('mobileReturn') === 'true') {
        // Show message to continue purchase
        showStatus("Welcome back! Please complete your purchase", "success");
        // Remove the parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Restore wallet options toggle
    function toggleWalletOptions() {
      walletOptions.style.display = walletOptions.style.display === 'flex' ? 'none' : 'flex';
    }

    // Real-time calculation
    function handleUSDTInput() {
      currentUSDTAmount = parseFloat(usdtInput.value) || 0;
      currentMZLxAmount = currentUSDTAmount / TOKEN_PRICE;
      updateMZLxOutput();
      updateBuyButtonState();
    }

    function updateMZLxOutput() {
      mzlxOutput.textContent = `You will receive: ${currentMZLxAmount.toFixed(2)} MZLx`;
    }
    
    function updateBuyButtonState() {
      buyBtn.disabled = !userAddress || currentUSDTAmount < TOKEN_PRICE;
    }

    // MetaMask connection - GUARANTEED to work on all platforms
    async function connectMetaMask() {
      walletOptions.style.display = 'none';
      
      try {
        showStatus("Connecting to MetaMask...", "processing");
        
        // Handle mobile devices with dedicated app
        if (isMobile && !window.ethereum) {
          // Redirect to MetaMask app with return URL
          const returnUrl = encodeURIComponent(`${window.location.href}?mobileReturn=true`);
          const deeplink = `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}?connector=metamask&returnUrl=${returnUrl}`;
          window.location.href = deeplink;
          return;
        }
        
        // Handle desktop browsers
        if (!window.ethereum) {
          showStatus("MetaMask not installed. Please install it first.", "error");
          return;
        }
        
        // Trigger MetaMask extension directly
        const accounts = await window.ethereum.request({ 
          method: 'eth_requestAccounts' 
        });
        
        // Switch to BSC
        await switchToBNBChain();
        
        // Initialize provider and signer
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Update UI
        showStatus("Wallet connected successfully!", "success");
        connectedInfo.style.display = "block";
        walletAddress.textContent = shortenAddress(userAddress);
        updateBuyButtonState();
        
      } catch (err) {
        showStatus("Connection failed: " + (err.message || err), "error");
        console.error("MetaMask connection error:", err);
      }
    }

    // WalletConnect connection
    async function connectWalletConnect() {
      walletOptions.style.display = 'none';
      
      try {
        showStatus("Preparing WalletConnect...", "processing");
        
        // Initialize WalletConnect
        walletConnectProvider = new WalletConnectProvider.default({
          rpc: { 
            56: "https://bsc-dataseed.binance.org/" 
          },
          chainId: BNB_CHAIN_ID,
          qrcodeModalOptions: {
            desktopLinks: ["metamask", "trust"],
            mobileLinks: ["metamask", "trust"]
          }
        });
        
        // Enable session - triggers QR modal
        await walletConnectProvider.enable();
        
        // Initialize provider and signer
        provider = new ethers.Web3Provider(walletConnectProvider);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Update UI
        showStatus("Wallet connected successfully!", "success");
        connectedInfo.style.display = "block";
        walletAddress.textContent = shortenAddress(userAddress);
        updateBuyButtonState();
        
      } catch (err) {
        showStatus("Connection failed: " + (err.message || err), "error");
        console.error("WalletConnect connection error:", err);
      }
    }

    async function switchToBNBChain() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x38' }]
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x38',
                chainName: 'Binance Smart Chain',
                nativeCurrency: { name: 'BNB', symbol: 'bnb', decimals: 18 },
                rpcUrls: ['https://bsc-dataseed.binance.org/'],
                blockExplorerUrls: ['https://bscscan.com']
              }]
            });
          } catch (addError) {
            console.error("Failed to add BSC network:", addError);
          }
        }
      }
    }

    // Purchase Process - Guaranteed Wallet UI
    async function startPurchaseProcess() {
      if (!userAddress || currentUSDTAmount < TOKEN_PRICE) {
        showStatus("Please connect wallet and enter valid USDT amount", "error");
        return;
      }
      
      try {
        showStatus("Preparing transaction...", "processing");
        
        // Reinitialize signer if needed
        if (!signer) {
          if (provider instanceof ethers.BrowserProvider) {
            signer = await provider.getSigner();
          } else {
            signer = provider.getSigner();
          }
        }
        
        // Get USDT contract with signer
        const usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
        
        // Get decimals
        const decimals = await usdtContract.decimals();
        const usdtValue = ethers.parseUnits(currentUSDTAmount.toString(), decimals);
        
        // Check balance
        const balance = await usdtContract.balanceOf(userAddress);
        if (balance < usdtValue) {
          showStatus(`Insufficient USDT balance. You need ${currentUSDTAmount} USDT`, "error");
          return;
        }
        
        // Check allowance
        const allowance = await usdtContract.allowance(userAddress, RECEIVER_ADDRESS);
        if (allowance < usdtValue) {
          // Trigger wallet's native approval interface
          await triggerApproval(usdtContract, usdtValue);
        }
        
        // Trigger wallet's native transfer interface
        await triggerTransfer(usdtContract, usdtValue);
        
        // Notify backend
        await notifyBackend();
        
        // Reset form
        usdtInput.value = "";
        currentUSDTAmount = 0;
        currentMZLxAmount = 0;
        updateMZLxOutput();
        updateBuyButtonState();
        
      } catch (err) {
        showStatus("Transaction failed: " + (err.message || err), "error");
        console.error("Transaction error:", err);
      }
    }
    
    // Trigger wallet's native approval interface
    async function triggerApproval(contract, value) {
      showStatus("Approval needed. Please confirm in your wallet...", "processing");
      
      // This will trigger the wallet's native UI
      const tx = await contract.approve(RECEIVER_ADDRESS, value);
      await tx.wait();
      showStatus("USDT spending approved!", "success");
    }
    
    // Trigger wallet's native transfer interface
    async function triggerTransfer(contract, value) {
      showStatus("Sending USDT. Please confirm in your wallet...", "processing");
      
      // This will trigger the wallet's native UI
      const tx = await contract.transfer(RECEIVER_ADDRESS, value);
      const receipt = await tx.wait();
      
      if (receipt.status === 1) {
        showStatus(`${currentUSDTAmount} USDT sent successfully!`, "success");
      } else {
        throw new Error("USDT transfer failed");
      }
    }
    
    // Notify backend
    async function notifyBackend() {
      if (!API_BASE_URL) return;
      
      try {
        showStatus("Processing MZLx tokens...", "processing");
        
        const response = await fetch(`${API_BASE_URL}/api/purchase`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            walletAddress: userAddress,
            usdtAmount: currentUSDTAmount,
            mzlxAmount: currentMZLxAmount
          })
        });
        
        if (!response.ok) {
          throw new Error('Backend notification failed');
        }
        
        showStatus(`Success! ${currentMZLxAmount.toFixed(2)} MZLx will be sent to your wallet`, "success");
      } catch (err) {
        console.error("Backend notification error:", err);
        showStatus("MZLx tokens will be sent shortly. Contact support if delayed.", "success");
      }
    }

    // Helper functions
    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status ' + type;
      statusMessage.style.display = 'block';
      
      if (type === 'processing') {
        statusMessage.innerHTML = `<span class="spinner"></span> ${message}`;
      }
      
      if (type === 'success') {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 10000);
      }
    }
    
    function shortenAddress(address) {
      return address ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : '';
    }
  </script>
</body>
</html>
