<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAZOL (MZLx) Token Sale</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #008080;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 10px;
      overflow-y: auto;
      touch-action: pan-y;
      -webkit-tap-highlight-color: transparent;
    }
    
    .container {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 25px;
      text-align: center;
      position: relative;
      margin: 20px 0;
    }
    
    .logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px auto;
      display: block;
      border-radius: 50%;
      object-fit: cover;
    }
    
    h1 {
      font-size: 1.3em;
      margin-bottom: 8px;
      color: #222;
      line-height: 1.3;
    }
    
    .subtitle {
      color: #1a73e8;
      font-size: 0.95em;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    
    .desc {
      color: #555;
      margin-bottom: 20px;
      font-size: 0.95em;
      line-height: 1.5;
    }
    
    .input-group {
      margin-bottom: 15px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-weight: 600;
      font-size: 0.95em;
    }
    
    input[type="number"] {
      width: 100%;
      padding: 14px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #f9f9f9;
      -webkit-appearance: none;
    }
    
    .output {
      margin-bottom: 15px;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.05em;
      color: #1a73e8;
    }
    
    button {
      width: 100%;
      padding: 16px;
      background: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
      transition: background 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button:hover:not(:disabled) {
      background: #0d5abf;
    }
    
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .wallet-options {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 25px;
      right: 25px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 10px;
      margin-bottom: 10px;
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .wallet-option {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      background: #f8f9fa;
    }
    
    .wallet-option:active {
      transform: translateY(1px);
    }
    
    .wallet-option:hover {
      background: #eef5ff;
    }
    
    .wallet-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      object-fit: contain;
    }
    
    .footer {
      text-align: center;
      color: #999;
      font-size: 0.85em;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .status {
      margin-top: 15px;
      padding: 14px;
      border-radius: 8px;
      display: none;
      font-size: 0.95em;
      line-height: 1.4;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.processing {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    
    .connected-wallet {
      font-size: 0.9em;
      margin: 10px 0 15px;
      color: #28a745;
      font-weight: 600;
      padding: 8px;
      background: #e8f5e9;
      border-radius: 6px;
    }
    
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
        border-radius: 10px;
      }
      
      h1 {
        font-size: 1.2em;
      }
      
      .logo {
        width: 90px;
        height: 90px;
      }
      
      button {
        padding: 14px;
        font-size: 1em;
      }
      
      .wallet-options {
        left: 15px;
        right: 15px;
      }
    }
    
    @media (max-height: 700px) {
      .wallet-options {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 30px);
        max-width: 350px;
        max-height: 70vh;
        bottom: auto;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@1.7.8/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  
  <div class="container">
    <img class="logo" src="https://i.imgur.com/gaCl9Zz.jpeg" alt="MAZOL Logo" />
    <h1>Private Sale: MAZOL (MZLx) Tokens</h1>
    <div class="subtitle">Blockchain Powered Trust-Grade Training and Marketplace Solutions</div>
    <div class="desc">Buy MZLx tokens with USDT (BEP-20, BNB Chain)<br>1 MZLx = 0.15 USDT</div>
    
    <div class="input-group">
      <label for="usdtAmount">Enter USDT Amount</label>
      <input type="number" id="usdtAmount" min="0.15" step="0.01" placeholder="e.g. 15" />
    </div>
    
    <div class="output" id="mzlxOutput">You will receive: 0 MZLx</div>
    
    <button id="connectBtn">Connect Wallet</button>
    <div id="walletInfo" class="connected-wallet" style="display: none;"></div>
    
    <div class="wallet-options" id="walletOptions">
      <div class="wallet-option" id="metamaskOption">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="wallet-icon" alt="MetaMask">
        <span>MetaMask</span>
      </div>
      <div class="wallet-option" id="walletConnectOption">
        <img src="https://avatars.githubusercontent.com/u/37784886" class="wallet-icon" alt="WalletConnect">
        <span>WalletConnect</span>
      </div>
    </div>
    
    <button id="buyBtn" disabled>Buy MZLx</button>
    
    <div class="status" id="statusMessage"></div>
    <div class="footer">Powered by MAZOLX</div>
  </div>

  <script>
    // ===== CONFIGURATION ===== //
    const TOKEN_PRICE = 0.15;
    const MZLX_ADDRESS = "0x49F4a728BD98480E92dBfc6a82d595DA9d1F7b83";
    const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
    const RECEIVER_ADDRESS = "0x4bd6033bCe207fa4F5a2Bd4d003a690ed4c3D859";
    const BNB_CHAIN_ID = 56;
    const API_BASE_URL = "https://mazol.onrender.com"; // UPDATE WITH YOUR BACKEND URL

    // ===== UI ELEMENTS ===== //
    const usdtInput = document.getElementById("usdtAmount");
    const mzlxOutput = document.getElementById("mzlxOutput");
    const connectBtn = document.getElementById("connectBtn");
    const buyBtn = document.getElementById("buyBtn");
    const walletOptions = document.getElementById("walletOptions");
    const statusMessage = document.getElementById("statusMessage");
    const metamaskOption = document.getElementById("metamaskOption");
    const walletConnectOption = document.getElementById("walletConnectOption");
    const walletInfo = document.getElementById("walletInfo");
    const overlay = document.getElementById("overlay");

    // ===== STATE VARIABLES ===== //
    let provider = null;
    let signer = null;
    let userAddress = null;
    let usdtDecimals = 18;
    let mzlxDecimals = 18;
    let walletConnectProvider = null;
    let currentUSDTAmount = 0;

    // ===== INITIAL SETUP ===== //
    document.addEventListener('DOMContentLoaded', initApp);
    
    function initApp() {
      // Initialize event listeners
      usdtInput.addEventListener('input', handleUSDTInput);
      connectBtn.addEventListener('click', toggleWalletOptions);
      metamaskOption.addEventListener('click', connectMetaMask);
      walletConnectOption.addEventListener('click', connectWalletConnect);
      buyBtn.addEventListener('click', startPurchaseProcess);
      overlay.addEventListener('click', closeWalletOptions);
      
      // Auto-connect if returning user
      if (window.ethereum && window.ethereum.selectedAddress) {
        connectMetaMask();
      }
      
      // Initialize calculation
      updateMZLxOutput();
    }

    function closeWalletOptions() {
      walletOptions.style.display = 'none';
      overlay.style.display = 'none';
    }

    function toggleWalletOptions() {
      if (walletOptions.style.display === 'block') {
        closeWalletOptions();
      } else {
        walletOptions.style.display = 'block';
        overlay.style.display = 'block';
        
        // Position dropdown for small screens
        if (window.innerHeight < 700) {
          walletOptions.style.position = 'fixed';
          walletOptions.style.top = '50%';
          walletOptions.style.left = '50%';
          walletOptions.style.transform = 'translate(-50%, -50%)';
          walletOptions.style.width = 'calc(100% - 30px)';
          walletOptions.style.maxWidth = '350px';
        }
      }
    }

    // ===== REAL-TIME CALCULATION ===== //
    function handleUSDTInput() {
      currentUSDTAmount = parseFloat(usdtInput.value) || 0;
      updateMZLxOutput();
    }

    function updateMZLxOutput() {
      const mzlxAmount = currentUSDTAmount > 0 ? currentUSDTAmount / TOKEN_PRICE : 0;
      
      mzlxOutput.textContent = `You will receive: ${mzlxAmount.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })} MZLx`;
      
      // Update button state
      buyBtn.disabled = !userAddress || currentUSDTAmount < TOKEN_PRICE;
    }

    // ===== WALLET CONNECTION ===== //
    async function connectMetaMask() {
      closeWalletOptions();
      
      if (!window.ethereum) {
        showStatus("MetaMask not detected. Please install MetaMask first.", "error");
        return;
      }
      
      try {
        showStatus("Connecting to MetaMask...", "processing");
        provider = new ethers.BrowserProvider(window.ethereum);
        await setupProvider(provider);
        showStatus("MetaMask connected successfully!", "success");
      } catch (err) {
        showStatus("MetaMask connection failed: " + (err.message || err), "error");
      }
    }

    async function connectWalletConnect() {
      closeWalletOptions();
      
      try {
        showStatus("Connecting to WalletConnect...", "processing");
        walletConnectProvider = new WalletConnectProvider.default({
          rpc: { 56: "https://bsc-dataseed.binance.org/" },
          chainId: 56,
        });

        await walletConnectProvider.enable();
        provider = new ethers.Web3Provider(walletConnectProvider);
        await setupProvider(provider);
        showStatus("WalletConnect connected successfully!", "success");
      } catch (err) {
        showStatus("WalletConnect failed: " + (err.message || err), "error");
      }
    }

    async function setupProvider(provider) {
      try {
        // Switch to BNB Chain
        await switchToBNBChain(provider);
        
        // Get signer
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Update UI
        connectBtn.textContent = "Connected";
        connectBtn.disabled = true;
        walletInfo.textContent = `Connected: ${shortenAddress(userAddress)}`;
        walletInfo.style.display = "block";
        
        // Get token decimals
        const usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
        usdtDecimals = await usdtContract.decimals();
        
        const mzlxContract = new ethers.Contract(MZLX_ADDRESS, ERC20_ABI, provider);
        mzlxDecimals = await mzlxContract.decimals();
        
        // Update button state
        updateMZLxOutput();
      } catch (err) {
        showStatus("Connection failed: " + (err.message || err), "error");
      }
    }

    async function switchToBNBChain(provider) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: "0x38" }]);
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await provider.send("wallet_addEthereumChain", [{
              chainId: "0x38",
              chainName: "Binance Smart Chain",
              nativeCurrency: { name: "BNB", symbol: "bnb", decimals: 18 },
              rpcUrls: ["https://bsc-dataseed.binance.org/"],
              blockExplorerUrls: ["https://bscscan.com"]
            }]);
          } catch (addError) {
            throw new Error("Failed to add BNB Chain");
          }
        } else {
          throw switchError;
        }
      }
    }

    // ===== PURCHASE WORKFLOW ===== //
    async function startPurchaseProcess() {
      if (!userAddress || currentUSDTAmount < TOKEN_PRICE) {
        showStatus("Please connect wallet and enter valid USDT amount", "error");
        return;
      }
      
      try {
        // Calculate values
        const mzlxAmount = currentUSDTAmount / TOKEN_PRICE;
        const usdtValue = ethers.parseUnits(currentUSDTAmount.toString(), usdtDecimals);
        
        // Step 1: Check balance
        const usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
        const usdtBalance = await usdtContract.balanceOf(userAddress);
        
        if (usdtBalance < usdtValue) {
          showStatus(`Insufficient USDT balance. You need ${currentUSDTAmount} USDT`, "error");
          return;
        }
        
        // Step 2: Check/Set allowance
        const allowance = await usdtContract.allowance(userAddress, RECEIVER_ADDRESS);
        
        if (allowance < usdtValue) {
          buyBtn.textContent = "Approving USDT...";
          buyBtn.disabled = true;
          showStatus("Approving USDT spending... Please confirm in wallet", "processing");
          
          // Force wallet to open by adding delay
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const approveTx = await usdtContract.approve(RECEIVER_ADDRESS, usdtValue);
          await approveTx.wait();
          
          showStatus("USDT spending approved!", "success");
        }
        
        // Step 3: Send USDT payment
        buyBtn.textContent = "Processing Payment...";
        showStatus("Sending USDT... Please confirm transaction", "processing");
        
        // Force wallet to open by adding delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const usdtTx = await usdtContract.transfer(RECEIVER_ADDRESS, usdtValue);
        const receipt = await usdtTx.wait();
        
        if (receipt.status !== 1) {
          throw new Error("USDT transfer failed");
        }
        
        showStatus(`USDT ${currentUSDTAmount} sent successfully!`, "success");
        
        // Step 4: Send to backend for token distribution
        buyBtn.textContent = "Processing Tokens...";
        showStatus("Processing MZLx tokens...", "processing");
        
        await sendToBackend({
          walletAddress: userAddress,
          usdtAmount: currentUSDTAmount,
          mzlxAmount: mzlxAmount,
          txHash: usdtTx.hash
        });
        
        showStatus(`Success! ${mzlxAmount.toFixed(2)} MZLx will arrive shortly`, "success");
        
      } catch (err) {
        showStatus("Transaction failed: " + (err.reason || err.message || err), "error");
      } finally {
        buyBtn.textContent = "Buy MZLx";
        buyBtn.disabled = !userAddress || currentUSDTAmount < TOKEN_PRICE;
      }
    }

    // ===== HELPER FUNCTIONS ===== //
    async function sendToBackend(data) {
      if (!API_BASE_URL) {
        console.log("Backend not configured. Skipping backend call.");
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/purchase`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error('Backend request failed');
        }
        
        const result = await response.json();
        return result;
      } catch (err) {
        console.error("Backend error:", err);
        throw new Error("Failed to process tokens. Contact support with TX: " + data.txHash);
      }
    }

    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status ' + type;
      statusMessage.style.display = 'block';
      
      // Auto-hide success messages after 15 seconds
      if (type === 'success') {
        setTimeout(() => {
          if (statusMessage.textContent === message) {
            statusMessage.style.display = 'none';
          }
        }, 15000);
      }
    }

    function shortenAddress(address) {
      return address ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : '';
    }

    // ERC20 ABI (minimal)
    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address owner) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
  </script>
</body>
</html>
